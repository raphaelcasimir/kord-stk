\graphicspath{{figures/Design/IPController/}}
\chapter{Design of the Inverted Pendulum Controller}\label{sec:IPController}
The goal of the controller is to balance the stick in an upright position. 
The system is inherently unstable as is evident by the pole in the right half plane of the pole-zero plot as seen on \autoref{fig:pzip}.

\begin{figure}[htbp]
\centering
\includegraphics[width=0.6\textwidth]{pzip}
\caption{Pole-zero plot for the inverted pendulums transfer function.}
\label{fig:pzip}
\end{figure}
\todo[inline,author=Jacob]{Check constants found by test and transfer function at the end.}

There's a plethora of different options for the controller to use; the simplest being a proportional controller. A simple way to check whether the proportional controller is feasible is by examining the root locus of the transfer function in \autoref{fig:locusIP}. The pole in the right half plane moving towards infinity is caused by the transfer function being negative and can be fixed with a negative gain as shown on figure \autoref{fig:locusNegative}.

\begin{figure}[htbp]
\centering
	\begin{subfigure}{0.45\textwidth}
	\includegraphics[width=\textwidth]{rlocusplus}
	\caption{Positive gain.}
	\label{fig:locusIP}
	\end{subfigure}
	\begin{subfigure}{0.45\textwidth}
	\centering
	\includegraphics[width=\textwidth]{rlocusminus}
	\caption{Negative gain.}
	\label{fig:locusNegative}
	\end{subfigure}
\caption{Root locus of the inverted pendulums transfer function.}
\end{figure}

The proportional controller isn't feasible as the pole in the right half plane never enters the stable region even with a negative gain.

The controller can be simplified by using cascade control. This means two controllers should be designed; one that controls the angle of the arm and one that controls the angle of the stick. The cascade control system can be seen on \autoref{fig:IPCascade}.

\begin{figure}[htbp]
\centering
\includegraphics[width=\textwidth]{IPCascade}
\caption{Block diagram of the inverted pendulum system with cascade control.}
\label{fig:IPCascade}
\end{figure}

If the inner loop is fast enough compared to the outer loop, it is negligible to the outer loop controller. This means the root locus of the can be split into two separate systems with a respective controller that needs to be designed. The root locus of the two subsystems is seen on \autoref{fig:locusSplit}.
\begin{figure}[htbp]
\centering
	\begin{subfigure}{0.45\textwidth}
	\includegraphics[width=\textwidth]{rlocusVArm}
	\caption{Voltage as input and angle of the arm as output.}
	\label{fig:locusVArm}
	\end{subfigure}
	\begin{subfigure}{0.45\textwidth}
	\includegraphics[width=\textwidth]{rlocusArmStick}
	\caption{Angle of the arm as input and angle of the stick as output.}
	\end{subfigure}
\caption{Root locus of the inner loop and outer loop.}
\label{fig:locusSplit}
\end{figure}

With this split it's simpler to design a controller that can move the unstable pole to the stable region. The outer loop controller will be designed first as it's essential to this split that the inner loop is faster than the outer loop. 

As the poles in feedback will eventually end up at the zeros with a large enough gain, there are two options to bring the unstable pole into the stable region: Removing all zeros in 0 so the pole can cross the into the stable region along the real axis or adding another unstable open loop pole to force the poles off the real axis and then try to circumvent the zeros in 0. 

Removing the zeros in 0 can theoretically be done by adding poles in 0 but this is dangerous \textbf{BUT I'M NOT SURE WHY}. Instead it's better to try and redefine the model output to something with a DC gain but at the same time requires the stick to be balanced to achieve the new output. This could be by attempting to control the position of a point on the stick. The stick would need to be balanced in order to have the point always be in the correct position.

%Cancelling zeros in 0 by adding poles can be dangerous as the steady state error will no longer be zero which is critical for a stable inverted pendulum. The system is difficult to control as the transfer function was derived with an attempt to control the angle of the stick. This is only really possible in the special case where the reference is exactly 0 at all times. The system can instead be redefined as trying to control the position of a point on the stick in relation to the vertical axis. By controlling the position instead of the angle would mean the system would still have to balance the stick but not be forced to use a reference of 0 at all times. This could make the system easier to control.

\section{Redefining the inverted pendulums output and reference point}
The inverted pendulum model will be redefined so the output is the distance from a point on the stick to the vertical axis instead of the angle of the stick. The point, $\alpha$, and the distance to the vertical axis, $x_\alpha$, are seen on \autoref{fig:modelDist}.

\begin{figure}[htbp]
\centering
\includegraphics[width=0.7\textwidth]{ModelDist}
\caption{Diagram of the distance that will be controlled instead of the angle of the stick.}
\label{fig:modelDist}
\end{figure}

The distance to the point can be described by \autoref{eq:xa}.
\begin{flalign}\label{eq:xa}
& x_\alpha(t) = l_a\sin(\theta_a(t))+l_\alpha\sin(\theta_s(t))
\end{flalign}
This is not a linear equation and needs to be linearized in order to Laplace transform it. This is done with a 1st order Taylor approximation around the equilibrium where $\theta_a=\theta_s=0$ in \autoref{eq:xaTaylor}
\begin{subequations}\label{eq:xaTaylor}
\begin{flalign}
& x_\alpha(t)\approx l_a\sin(0)+l_a\cos(0)\theta_a(t)+l_\alpha\sin(0)+l_\alpha\cos(0)\theta_s(t) \\
& x_\alpha(t)\approx l_a\theta_a(t)+l_\alpha\theta_s(t)
\end{flalign}
\end{subequations}
This will then be Laplace transformed in \autoref{eq:xaLaplace}.
\begin{flalign}\label{eq:xaLaplace}
X_\alpha(s)=l_a\Theta_a(s)+l_\alpha\Theta_s(s) 
\end{flalign}

By isolating $\Theta_s(s)$ in \autoref{eq:tfArmStick} and inserting it into \autoref{eq:xaLaplace}, the transfer function in \eqref{eq:xatf} is found. The friction part is removed per \autoref{tab:IPModelVar}.

\begin{subequations}
\begin{flalign}
& X_\alpha(s)=l_a\Theta_a(s)+l_\alpha\frac{-\frac{3l_a}{2l_s}s^2}{s^2-\frac{3g}{2l_s}}\Theta_a(s) \\
& X_\alpha(s)=\frac{l_a\left(s^2-\frac{3g}{2l_s}\right)+l_\alpha\left(-\frac{3l_a}{2l_s}s^2\right)}{s^2-\frac{3g}{2l_s}}\Theta_a(s) \\
& \frac{X_\alpha(s)}{\Theta_a(s)} = \frac{s^2\left(l_a-l_\alpha\frac{3l_a}{2l_s}\right)-l_a\frac{3g}{2l_s}}{s^2-\frac{3g}{2l_s}} \label{eq:xatf}
\end{flalign}
\end{subequations}
The transfer function still ends up with 2 zeros but it's possible to remove them by selecting the point $\alpha$ so $l_\alpha=\frac{2l_s}{3}$. Inserting this into \autoref{eq:xatf} the transfer function becomes \autoref{eq:xaTF}.
\begin{flalign}\label{eq:xaTF}
& \frac{X_\alpha(s)}{\Theta_a(s)} = \frac{-l_a\frac{3g}{2l_s}}{s^2-\frac{3g}{2l_s}}
\end{flalign}

The zeros in 0 has been removed but the distance, $x_\alpha$, now needs to be measured for the feedback. This can be done by measuring the angles, which was also necessary before, but now use \autoref{eq:xa} to calculate the distance instead of using the angle directly. The controller for the transfer function in \autoref{eq:xaTF} can now be designed.
\section{Design of Outer Loop Controller}
%The controller for the system will be split into two. One controller in an inner loop that controls the angle of the arm and one in an outer loop that controls the position of the stick. The system with the two controllers can be seen on the block diagram on \autoref{fig:IPBlock}.
%
The new block diagram for the controllers can be seen on \autoref{fig:IPBlock}.
\begin{figure}[htbp]
\centering
\includegraphics[width=\textwidth]{IPBlock}
\caption{Block diagram of the inverted pendulum system with inner and outer loop controllers.}
\label{fig:IPBlock}
\end{figure}
%
%If the inner loop is faster than the outer loop then it can be assumed to be irrelevant when designing the outer loop controller.

With the redefined transfer function the outer loop will control the transfer function in \autoref{eq:xaTF}. From the root locus in \autoref{fig:locusxa} it can be seen that a zero needs to be added on the real axis in the left half plane in order to move the pole in the right half plane to the stable region. 

\begin{figure}[htbp]
\centering
\includegraphics[width=0.7\textwidth]{rlocusRedef}
\caption{Root locus of the transfer function from the angle of the arm to the position of a point on the stick.}
\label{fig:locusxa}
\end{figure}

If the zero is positioned between the two poles both the right most will move towards the zero while the leftmost moves towards infinity; both along the real axis. Positioning the zero close to the origin doesn't allow for the pole to move far into the left half plane. If it's put far to the left of the stable pole the poles will move off the real axis and to the left of the zero with higher gain. This can move them very far into the left half plane before they come back to the real axis which could cause issues for making the inner loop faster than the outer loop. This is because the further away the poles are from origin the higher the natural frequency and a high natural frequency means small settling time. If the poles are off the real axis it'll introduce overshoot which needs to be under 10\% per the specifications. 

Placing the zero close to and on the right of the leftmost pole would allow for the unstable pole to move further into the left half plane without an overly fast response or any overshoot. 

The zero could theoretically be placed on the pole to cancel it and allow the pole to move further into the left half plane along the real axis. This would be ideal but the true location of the pole of the real system is difficult to find as small variations in measurements of the system could move the pole slightly. 

The zero will therefore initially be placed at -6 which is close to but on the right of the pole in the left half plane. This can be seen in \autoref{fig:rlocusZeroAdded}.

\begin{figure}[htbp]
\centering
\includegraphics[width=0.7\textwidth]{rlocusZeroAdded}
\caption{Root locus of the outer loop system with a zero added at -6.}
\label{fig:rlocusZeroAdded}
\end{figure}

The unstable pole can now enter the stable region by selecting a gain large enough. \todo[inline,author=Jacob]{The zero amplifies high frequency noise which can be fixed with a pole more to the left ~10-20 times.} Selecting the gain too large will however move the other pole further into the left half plane making it more difficult to make the inner loop system faster than the outer loop. As both the zero placement and gain needs to be adjusted later in conjunction with the inner loop controller, the gain will be set to 1 as this puts the unstable pole in the left half plane without the other pole moving too far away as seen on the pole-zero plot on \autoref{fig:pzouterloop}.

\begin{figure}[htbp]
\centering
\includegraphics[width=0.7\textwidth]{pzouterloop}
\caption{Pole-zero plot of the system with the outer loop controller in feedback.}
\label{fig:pzouterloop}
\end{figure}

\todo[inline,author=Jacob]{Write about simulating this and how the zero and gain is implemented in simulink. Calculate what kp and kd should be to achieve the zero location and gain in simulink. Do a matlab graph of step response to see settling time and overshoot.}

\section{Design of Inner Loop Controller}
For the design of the inner loop controller it's important that it settles faster than the outer loop controller. This means the natural frequency of the system with the controller needs to be larger. The root locus for the motor to the arm on \autoref{fig:locusVArm} shows that a simple gain could increase the natural frequency, but will also increase the overshoot as the poles moves further away from the real axis. A compensator should be added to bring the poles closer to the real axis to limit the overshoot. This can be done by placing a zero far into the left half plane which forces both poles to the left of it and to the real axis. Placing the zero at -20 for example gives the root locus on \autoref{fig:locusVArmZero}.

\begin{figure}[htbp]
\centering
\includegraphics[width=0.7\textwidth]{rlocusVArmZero}
\caption{Root locus of the inner loop with a zero in -20 added.}
\label{fig:locusVArmZero}
\end{figure}

By moving the zero further into the left half plane gives a faster settling time but requires a higher gain and a faster sampling rate for a digital controller. Having a higher gain can give issues with saturating the motor and there may be limits from the sampling rate with very fast settling times. 

\todo[inline,author=Jacob]{Maybe find maximum gain allowed based on motor saturation. Then place zero and high frequency pole to get a fast settling time, small overshoot and small steady state error.}

\todo[inline,author=Jacob]{Look into PID as it adds two zeros and is a well documented type of controller. Especially because lead control gives steady state error and the integration can remove it. SSE is terrible for the inner loop but ok for the outer as it's the position and not the angle.}







%\todo[inline,author=Jacob]{For the rest of this section: Use root locus to design Dx controller (Maybe parts of next section can be used here), then design Dm controller while keeping in mind it should be faster than Dx. I'd like for the angle of the stick to somehow be shown as a disturbance in the system and relate the redefinition to feedforward control for better disturbance rejection if possible. Tune parameters in the end as inner loop will have an effect on outer loop.}

%\section{Controller with a 2nd right half plane pole added}
%\todo[author=Jacob, inline]{A lot of this only applies for 2nd order system which this is not. I already wrote it without considering that so this section might have to be deleted but I'm leaving it for now. 2 zeros in 0 is also a massive pain in the ass.}
%A different control method will be attempted in this section where the model won't be redefined but rather a 2nd pole will be added to the right half plane in an attempt to circumvent the zeros in 0.
%
%This controller adds a zero and a pole to the system and thus have three variables that needs to be chosen: The gain and the locations of the zero and the pole. The pole has to be located somewhere in the right half plane and the zero in the left. Their exact locations influence the root locus of the system.
%
%To make the system as stable as possible a fast rise time and low overshoot is desirable. From the specifications the overshoot is set as maximum 10\% with no requirements for the rise time. The damping ratio, $\zeta$, can be found from the overshoot percentage, $M_p$, by \autoref{eq:IPOvershoot}.
%\begin{subequations}
%\begin{flalign}
%& M_p=100\exp^{\frac{-\pi\zeta}{\sqrt{1-\zeta^2}}}<10\%  \\
%& \zeta = \sqrt{\frac{\left(\ln{\frac{M_p}{100}}\right)^2}{\pi^2+\left(\ln{\frac{M_p}{100}}\right)^2}}  \\
%& \zeta > \sqrt{\frac{\left(\ln{\frac{10\%}{100}}\right)^2}{\pi^2+\left(\ln{\frac{10\%}{100}}\right)^2}} = 0.59 \label{eq:IPOvershoot}
%\end{flalign}
%\end{subequations}
%
%The damping ratio then has to be larger than 0.59 in order to have a overshoot of less than 10\% as specified. The rise time, $t_r$, is approximated by \autoref{eq:IPRisetime}.
%\begin{flalign}\label{eq:IPRisetime}
%& t_r =\frac{2.2}{\zeta\omega_n} 
%\end{flalign}
%
%In order to get as fast a rise time as possible the natural frequency and damping ratio both needs to be maximized. The natural frequency can be found on the root locus by the length from the poles to the origin. The damping ratio is found by the angle from the imaginary axis to the poles. As both $\zeta$ and $\omega_n$ are dependent on the pole locations it's possible that the fastest response time comes with a damping ratio below 0.59. The goal of this controller is to minimize \autoref{eq:IPRisetime} but maintaining a damping ratio above 0.59.
%
%The location of the pole, and zero and the gain can thus be decided in order to achieve final pole locations with as far away from the origin as possible while having an angle to the imaginary axis that corresponds to $\zeta=0.59$.

%For the inverted pendulum it's also worth to consider a controller that keeps the arm at zero radians as well as it has a much harder time controlling the arm when out of the upright position. Therefore two controllers will be made: A single-input single-output (SISO) controller that only controls the angle of the stick and a single-input multiple-output (SIMO) controller that controls both the angle of the stick and the arm. 
%\todo[inline,author=Jacob]{If time allows. Otherwise just SISO.}

%\section{Single input single output controller for the inverted pendulum}
%For the SISO controller at least a zero or pole must be introduced along with the P-controller in the system in order to move the pole in the right half plane to the left half plane. For the pole in the right half plane to cross into the left half plane a pole must be added either in 0 to cancel the zero or in the right half plane forcing both off the real axis and allowing them to circumvent the zero in 0 and enter the stable region.

