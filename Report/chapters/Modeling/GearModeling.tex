\graphicspath{{figures/modeling/gearTrain/}}
\section{Modeling of the Gear System}\label{sec:ModGearSys}
In this section, the gear system will be modeled. 

\todo [inline,author=Geoff]{Work on intro and maybe put figure}


Three transfer functions are going to be determined in this section. First, the transfer of the motor's angular velocity $\omega_m$ to the angle of the arm $\theta_a$ through the gears. Then, too transfer functions are needed for $\tau_L$: the torque of the load comes from both the torque of the arm and stick $\tau_{as}$ and, considering the frictions in the gears, from $\omega_m$ itself.


\subsection{Relation between $\Omega_m$ and $\Theta_a$}

\begin{figure}[htbp]
	\centering
 	\includegraphics[width=1\textwidth]{figures/FigureIsComing.PNG} 
 	\caption{Part of the gear structure. The whole gear system consists of three of them.}
 	\label{fig:GearPart}
\end{figure}


From \autoref{fig:GearPart}, considering the small wheel as the one connected to the motor, if the motor shaft turns, the belt joining the small and the big wheel will make them turn the same distance:
\begin{equation}
	\theta_m r_m = \theta_w r_w
\end{equation}

This expression is then differentiated to find the relation with the angular velocities:
\begin{equation}
	\omega_m r_m = \omega_w r_w
	\label{eq:AngularVelRelation}
\end{equation}

The gear ratio is defined as: 
\begin{equation}
	N = \frac{r}{R}
\end{equation}

As the gear system is composed by three similar connected wheels structures like shown in \autoref{fig:GearPart}, the ratio between small wheel x, $r_x$, and big wheel x, $R_x$ is the same:
\begin{equation}
	\frac{r_x}{R_x} = \frac{r_{motor}}{R_{w_1}} = \frac{r_{w_1}}{R_{w_2}} = \frac{r_{w_2}}{R_{w_3}} = N
\end{equation}

Knowing this and since $\omega_m$ is transferred through three gears, the relation between the angular velocity of the motor $\omega_m$ and the angle of the arm $\theta_a$ is found following the principle of \autoref{eq:AngularVelRelation}:
\begin{subequations} \label{eq:tech_ToA}
	\begin{flalign}
		&\dot{\theta}_a(t) = N^3 \omega_m(t) \\
		&\dot{\theta}_a(t) = N^3 \int_{0}^{t}\omega_m(v) dv \\
		&\mathscr{L}\{\dot{\theta}_a(t)\} = \Theta_a(s) = N^3 \cdot \frac{1}{s} \Omega_m(s)
	\end{flalign}
\end{subequations}

The transfer function from the motor's angle velocity to the angle of the arm is:
\begin{equation}\label{eq:thetaOmega}
	\frac{\Theta_a(s)}{\Omega_m(s)} =  \frac{N^3}{s}
\end{equation}

\subsection{Linear Model}
\todo[inline,author=Geoff]{Why linear model?}

In order to design an effective feedback control system a linear models is a necessity. As seen previously in \autoref{eq:thetaOmega} $\frac{\Theta_a(s)}{\omega_m(s)}$ is already a linear relationship. So in order to get a linear system only the transfer function $\frac{\omega_m(s)}{U(s)}$ has to be linearized.

It can be seen from \autoref{eq:DCMotorTFWithLoad}, that in order to linearize $\frac{\omega_m(s)}{U(s)}$ $\tau_l$ has to be rewrite in function of $U(s)$ and $\omega_m(s)$.

\subsection{Determining $\tau_l$}
As said in \autoref{sec:ModGearSys} $\tau_l(s)$ is the torque of the load. In the inverted pendulum case the load is composed of the friction and the torque necessary to counter the gravity which result in \autoref{eq:TauL}.

\begin{equation}\label{eq:TauL}
	\tau_l = \tau_f + \tau_{as}
\end{equation}

It is necessary then to derive $\tau_f$ and $\tau_{as}$ to see if they are requiring linearization.

\subsubsection*{Determining $\tau_{f}$}
The gear train is composed by three identical belt and pulley system. \autoref{fig:Belt&Pulley} corresponds to the first system between the motor and the first wheel. 
\begin{figure}[htbp]
    \centering
    \includegraphics[width=1\textwidth]{figures/FigureIsComing.PNG}
    \caption{Body diagram of a belt and pulley system}
    \label{fig:Belt&Pulley}
\end{figure}

\startexplain
\explain{$J_m$ is the moment of inertia of the motor}{\si{\kilogram\meter\squared}}
\explain{$J_w$ is the moment of inertia of the wheel}{\si{\kilogram\meter\squared}}
\explain{$\omega_m$ is the motor's angular velocity}{\si{\meter\per\second}}
\explain{$\tau_m$ is the torque of the motor}{\si{\newton\meter}}
\explain{$F_1$ is the force transferred from the motor to the wheel}{\si{\newton}}
\explain{$r$ is the radius of the motor's wheel}{\si{\meter}}
\explain{$R$ is the radius of the wheel}{\si{\meter}}
\explain{$\tau_f$ is the torque of the gear train friction}{\si{\newton\meter}}
\explain{$\tau_L$ is the torque of the wheel's load}{\si{\newton\meter}}
\explain{$b_w$ is the viscous friction coefficient of the wheel}{\si{\newton\meter\per\radian\per\second}}
\stopexplain



\begin{figure}[htbp]
    \centering
    \includegraphics[width=1\textwidth]{figures/FigureIsComing.PNG}
    \caption{Body diagram of the motor wheel}
    \label{fig:BodyDiagramsMotorWheel}
\end{figure}

Using the previously stated $2^{nd}$ law of motion, the mechanical equation for the motor wheel can be found from \autoref{fig:BodyDiagramMotorWheel}:

\begin{equation}
    J_m \dot{\omega}_m = \tau_m + F_1r - \tau_f
\end{equation}

For the body diagram for the wheel in \autoref{fig:BodyDiagramsMotorWheel}:
\begin{equation}
	J_w\dot{\omega}_w = -F_1R -\tau_L -b_w\omega_w
\end{equation}

Looking at the whole gear train, $tau_f$ represents the total friction and $\tau_L$ corresponds to the torque transferred to the next wheel. Which gives for wheels 1, 2 and 3:

\begin{subequations} 
	\begin{flalign}
		&J_w\dot{\omega}_{w_1} = -F_1R -F_2r -b_{w_1}\omega_{w_1} \\
		&J_w\dot{\omega}_{w_2} = -F_2R -F_3r -b_{w_2}\omega_{w_2} \\
		&J_w\dot{\omega}_{w_3}= -F_3R -b_{w_3}\omega_{w_3}
	\end{flalign}
\end{subequations}



\subsubsection*{Determining $\tau_{as}$}

$\tau_{as}$ is the torque necessary for the arm to counter the load applied by the arm and the stick. It can be divided into two parts.

The first part is the torque generated by the arm.

 One part $\tau_a$ is generated when the arm is not parallel to the gravitational force. As seen in \autoref{fig:tauA} this force can be seen as the pendulum where the mass is concentrated in the GC and has a weightless rod, so the gravitational force can be summarized as \autoref{eq:tauA}.

\begin{figure}[htbp]
	\missingfigure{A diagram showing how the gravity affects the arm}
	\caption{Diagram of the gravitational force on the arm}\label{fig:tauA}
\end{figure}

\begin{equation}\label{eq:tauA}
	\tau_a=M_a\cdot g \cdot \frac{l_a}{2} sin(\Theta_a) \addunit{\newton\meter}
\end{equation}
\startexplain
\explain{$M_a$ is the mass of the arm}{\si{\kilogram}}
\stopexplain

A torque $\tau_{am}$ is also generated by the momentum of the arm when it moves. This can be translated by the \autoref{eq:ArmMomentum}.

\begin{equation}\label{eq:ArmMomentum}
	\tau_{am}=\dot\omega_a\ \cdot J_a \addunit{\newton\meter}
\end{equation}
\startexplain
\explain{$\omega_a$ is the velocity of the arm}{\si{\meter\per\second}}
\explain{$J_a$ is the moment of inertia of the arm}{\si{\kilogram\meter\squared}}
\stopexplain

The second part is the torque generated by the stick

$\tau_s$ is the load generated by the stick due to the gravity. Since the stick is connected to one of the extremities of the arm and the load of the arm is already accounted it is once again a classical pendulum case with weightless rod which can be translated to \autoref{eq:StickGravLoad}.

\begin{equation}\label{eq:StickGravLoad}
	\tau_s = l_a\cdot sin(\Theta_a) \cdot \frac{l_s}{2}\cdot M_s\cdot g\cdot cos(\Theta_s) \addunit{\newton\meter}
\end{equation}

$\tau_{sm}$ is the load generated by the momentum of the stick. However the velocity of the stick is very low so the load of its momentum compared to the load generated by the gravity is negligible. \todo[inline,author=Max]{an actual test or a reason has to be found to be able to say so. This may also apply for the momentum of the arm}

So by combining Equations (\ref{eq:tauA}), (\ref{eq:ArmMomentum}) and (\ref{eq:StickGravLoad}) \autoref{eq:finalTauL} is obtained.

\begin{equation}\label{eq:finalTauL}
	\begin{flalign}
	\tau_l=&M_a\cdot g \cdot \frac{l_a}{2} sin(\Theta_a)+\dot\omega_a\ \cdot J_a \\
	&+l_a\cdot sin(\Theta_a) \cdot \frac{l_s}{2}\cdot M_s\cdot g\cdot cos(\Theta_s) \addunit{\newton\meter}
	\end{flalign}
\end{equation}

Since it is a change in the small angles the linearization of a cosine and a sine function gives \autoref{eq:BasLin}.

\begin{subequations}\label{eq:BasLin}
	\begin{flalign}
		&\mathscr{L}{sin(x)}=x \addunit{1}\\
		&\mathscr{L}{cos(x)}=1 \addunit{1}
	\end{flalign}
\end{subequations}

\autoref{fig:BasLinPlot} shows that within an angle variation of \SI{10}{\degree} the approximation of the linearization is acceptable.

\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.8\textwidth]{CosSinLinApprox}
	\caption{Error generated by the approximation of the cosine and the sine function}\label{fig:BasLinPlot}
\end{figure}