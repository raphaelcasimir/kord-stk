\newpage
\graphicspath{{figures/modeling/gearTrain/}}
\section{Modeling of the Gear System}\label{sec:ModGearSys}
In this section, the gear system will be modeled. 

\todo [inline,author=Geoff]{Work on intro and maybe put figure , describe OmegaM before showing the relation, or change the head line to small omega and theta, because then the explanation is there.}
\todo{Use a diagram to explain the relation, the one for inverted pendulum hardware can be used with only input output of gear system.}

Three transfer functions are going to be determined in this section. First, the transfer of the motor's angular velocity $\omega_m$ to the angle of the arm $\theta_a$ through the gears. Then, two transfer functions are needed for $\tau_l$: the torque of the load comes from both the torque of the arm and stick $\tau_{as}$ and the frictions generated by the gears.


\subsection{Relation between $\Omega_m$ and $\Theta_a$}

\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.9\textwidth]{figures/modeling/gearTrain/GearAndBeltSystem.pdf}
	\caption{Body diagram of the motor wheel system}
	\label{fig:Belt&Pulley}
\end{figure}

\startexplain
\explain{$J_m$ is the moment of inertia of the motor}{\si{\kilogram\meter\squared}}
\explain{$J_w$ is the moment of inertia of the wheel}{\si{\kilogram\meter\squared}}
\explain{$\omega_m$ is the motor's angular velocity}{\si{\meter\per\second}}
\explain{$\tau_m$ is the torque of the motor}{\si{\newton\meter}}
\explain{$F_1$ is the force transferred from the motor to the wheel}{\si{\newton}}
\explain{$r$ is the radius of the motor's wheel}{\si{\meter}}
\explain{$R$ is the radius of the wheel}{\si{\meter}}
\explain{$\tau_f$ is the torque of the gear train friction}{\si{\newton\meter}}
\explain{$\tau_L$ is the torque of the wheel's load}{\si{\newton\meter}}
\explain{$b_w$ is the viscous friction coefficient of the wheel}{\si{\newton\meter\per\radian\per\second}}
\stopexplain


From \autoref{fig:Belt&Pulley}, considering the small wheel as the one connected to the motor, if the motor shaft turns, the belt joining the small and the big wheel will make them turn the same distance:
\begin{equation}
	\theta_m r = \theta_w R \addunit{\meter}
\end{equation}

This expression is then differentiated to find the relation with the angular velocities:
\begin{equation}
	\omega_m r = \omega_w R\addunit{\meter\per\second}
	\label{eq:AngularVelRelation}
\end{equation}

Then the gear ratio can be defined as: 
\begin{equation}
	N = \frac{r}{R} \addunit{1}
	\label{eq:GearRatio}
\end{equation}

As the gear system is composed by three similar connected wheels structures like shown in \autoref{fig:Belt&Pulley}, the ratio between small wheel x, $r_x$, and big wheel x, $R_x$ is the same:
\begin{equation}
	\frac{r_x}{R_x} = \frac{r_{motor}}{R_{w_1}} = \frac{r_{w_1}}{R_{w_2}} = \frac{r_{w_2}}{R_{w_3}} = N \addunit{1}
\end{equation}
\todo{Does it become n3 because of the three ratios? Because then that needs to be clarified. I know it is written that it is transferred trough three gears, but then conclude that then N3 comes from that.}
Knowing this and since $\omega_m$ is transferred through three gears, the relation between the angular velocity of the motor $\omega_m$ and the angle of the arm $\theta_a$ is found following the principle of \autoref{eq:AngularVelRelation}:
\begin{subequations} \label{eq:tech_ToA}
	\begin{flalign}
		&\omega_a(t) = N^3 \omega_m(t) \\
		&\theta_a(t) = N^3 \int_{0}^{t}\omega_m(v) dv \\
		&\mathcal{L}\{\theta_a(t)\} = \Theta_a(s) = N^3 \cdot \frac{1}{s} \Omega_m(s) \addunit{1}
	\end{flalign}
\end{subequations}

The transfer function from the motor's angle velocity to the angle of the arm is:
\begin{equation}\label{eq:thetaOmega}
	\frac{\Theta_a(s)}{\Omega_m(s)} =  \frac{N^3}{s} \addunit{1}
\end{equation}

\subsection{Linear Model}
\todo[inline,author=Geoff/Mathias]{Why linear model?, call it something with linearization of... Generally i think alot of the explanations is just describing the variables, instead of making a where: explain. I would prefer a list instead of it written inside the text. And generally some where: explanations is missing.}

In order to design an effective feedback control system a linear model is a necessity. As seen previously in \autoref{eq:thetaOmega} $\frac{\Theta_a(s)}{\omega_m(s)}$ is already a linear relationship. So in order to get a linear system only the transfer function $\frac{\omega_m(s)}{U(s)}$ has to be linearized.

It can be seen from \autoref{eq:DCMotorTFWithLoad}, that in order to linearize $\frac{\omega_m(s)}{U(s)}$ $\tau_l$ has to be rewrite in function of $U(s)$ and $\omega_m(s)$.

\subsection{Determining $\tau_l$}
As said in \autoref{sec:ModGearSys} $\tau_l(s)$ is the torque of the load. In the inverted pendulum case the load is composed of the friction and the torque necessary to counter the gravity which result in \autoref{eq:TauL}.

\begin{equation}\label{eq:TauL}
	\tau_l = \tau_{f_{gear}} + \tau_{as} \addunit{\newton\meter}
\end{equation}

It is necessary then to derive $\tau_{f_{gear}}$ and $\tau_{as}$ to see if they are requiring linearization.


\subsubsection*{Determining $\tau_{f_{gear}}$}
The gear train is composed by three identical belt and pulley system. \autoref{fig:Belt&Pulley} corresponds to the first system between the motor and the first wheel. 

Using the previously stated $2^{nd}$ law of motion, the mechanical equation for the motor wheel can be found from \autoref{fig:MotorBodyDiagram}:

\begin{equation}
    J_m \dot{\omega}_m = \tau_m + F_1r - b_m\omega_m \addunit{\newton\meter}
    \label{eq:MotorfreeBody}
\end{equation}

For the body diagram for the wheel in \autoref{fig:Belt&Pulley}:
\begin{equation}
	J_w\dot{\omega}_w = -F_1R -\tau_L -b_w\omega_w \addunit{\newton\meter}
\end{equation}

Looking at the whole gear train, $\tau_{f_{gear}}$ represents the total friction and $\tau_L$ is the opposite of the torque transferred to the next wheel. Which gives for wheels 1, 2 and 3:

\begin{subequations} 
	\begin{flalign} \label{eq:GiveMeAnOriginalName}
		&J_{w_1}\dot{\omega}_{w_1} = -F_1R + F_2r -b_{w_1}\omega_{w_1} \addunit{\newton\meter}\\ 
		&J_{w_2}\dot{\omega}_{w_2} = -F_2R + F_3r -b_{w_2}\omega_{w_2} \addunit{\newton\meter}\\ 
		&J_{w_3}\dot{\omega}_{w_3} = -F_3R - b_{w_3}\omega_{w_3} \addunit{\newton\meter}
	\end{flalign}
\end{subequations}

Using the relation in \autoref{eq:AngularVelRelation}, the angular velocity of each wheels can be found according to $\omega_m$:
\begin{subequations} 
	\begin{flalign}
		&\omega_{w_1} = N \omega_m \addunit{\radian\per\second}\\
		&\omega_{w_2} = N \omega_{w_1} = N^2 \omega_m \addunit{\radian\per\second}\\
		&\omega_{w_3} = N \omega_{w_2} = N^3 \omega_m \addunit{\radian\per\second}
	\end{flalign}
\end{subequations}

The same equations are valid with angular accelerations.
Which gives for Equations \ref{eq:GiveMeAnOriginalName}:
\begin{subequations} 
	\begin{flalign}  
		&J_{w_1}N\dot{\omega}_m = -F_1R + F_2r -b_{w_1}N\omega_m \addunit{\newton\meter}\\ 
		&J_{w_2}N^2\dot{\omega}_m = -F_2R + F_3r -b_{w_2}N^2\omega_m  \addunit{\newton\meter}\\ 
		&J_{w_3}N^3\dot{\omega}_m = -F_3R - b_{w_3}N^3\omega_m  \addunit{\newton\meter}
	\end{flalign}
\end{subequations}

The total friction torque $\tau_{f_{gear}}$ in the gear train is the torque that needs to be overcome by the torque of the motor in order to make the gear train move. It means that when the gear train is static:

\begin{subequations} \label{eq:findTauf}
	\begin{flalign}
		&\omega_m = \SI{0}{\radian\per\second}\\
		&\tau_m \leqslant \tau_{f_{gear}} \addunit{\newton\meter}
	\end{flalign}
\end{subequations}

To find $\tau_{f_{gear}}$, the special case where $\tau_m = \tau_{f_{gear}}$ is studied. Inserting \autoref{eq:findTauf} into \autoref{eq:MotorfreeBody}:

\begin{equation} 
		\tau_{f_{gear}} = -F_1 \cdot r \addunit{\newton\meter}
		\label{eq:TaufF1r}
\end{equation}

$F_1$ needs to be isolated from \autoref{eq:GiveMeAnOriginalName}. Each forces $F_1$, $F_2$ and $F_3$ are then isolated, giving: 

\begin{subequations} 
	\begin{flalign}
		&F_1 = -\frac{1}{R} (b_{w_1}N\omega_m + J_{w_1}N\dot{\omega}_m - F_2r) \addunit{\newton} 	\label{eq:F1}\\ 
		&F_2 = -\frac{1}{R} (b_{w_2}N^2\omega_m +  J_{w_2}N^2\dot{\omega}_m - F_3r) \addunit{\newton}	\label{eq:F2}\\
		&F_3 = -\frac{1}{R} (b_{w_3}N^3\omega_m + J_{w_3}N^3\dot{\omega}_m)	\addunit{\newton}		\label{eq:F3}
	\end{flalign}
\end{subequations}

Inserting \autoref{eq:F3} in \autoref{eq:F2}, then \autoref{eq:F2} in \autoref{eq:F1}, the expression of $F_1$ according to the friction and moment of inertia of each wheel is found:

\begin{flalign}
	F_1 &=-\frac{1}{R} N(b_{w_1}\omega_m + J_{w_1}\dot{\omega}_m \notag \\
	& +\frac{r}{R} N^2(b_{w_2}\omega_m + J_{w_2}\dot{\omega}_m \notag \\
	& +\frac{r}{R} N^3(b_{w_3}\omega_m + J_{w_3}\dot{\omega}_m))) \addunit{\newton}
\end{flalign}


Using \autoref{eq:TaufF1r} and the gear ratio in \autoref{eq:GearRatio}, the total friction is given by: 
\begin{align} \label{eq:TaufTimeDomain}
	\tau_{f_{gear}} &= N^2 (b_{w_1}\omega_m + J_{w_1}\dot{\omega}_m \notag \\
	& +N^3 (b_{w_2}\omega_m + J_{w_2}\dot{\omega}_m \notag \\
	& +N^4 (b_{w_3}\omega_m + J_{w_3}\dot{\omega}_m))) \addunit{\newton\meter}
\end{align}


\autoref{eq:TaufTimeDomain} is Laplace-transformed:

\begin{flalign} \label{eq:TaufLaplaceDomain}
	\mathcal{L}\{\tau_{f_{gear}}(t)\} = \tau_{f_{gear}}(s) &= N^2 (B_{w_1}\Omega_m + sJ_{w_1}\Omega_m \notag \\
	& +N^3 (B_{w_2}\Omega_m + sJ_{w_2}\Omega_m \notag \\
	& +N^4 (B_{w_3}\Omega_m + sJ_{w_3}\Omega_m))) \addunit{1}
\end{flalign}


\autoref{eq:TaufLaplaceDomain} is reorganized to find the final expression for $\tau_{f_{gear}}$ in \autoref{eq:TaufReorganized}:
\begin{equation}
	\tau_{f_{gear}} = \left[(N^2 J_1 + N^3 J_2 + N^4 J_3)s +( N^2 B_1 + N^3 B_2 + N^4 B_3)\right]\Omega_m \addunit{1}
	\label{eq:TaufReorganized}
\end{equation}

The moments of inertia and the frictions of each parts of the gear train will be grouped into two variables, respectively $J_{gear}$ and $B_{gear}$:
\begin{equation}
	\tau_{f_{gear}} = (J_{gear}s +B_{gear})\Omega_m \addunit{1}
	\label{eq:TaufSimplified}
\end{equation}











\subsubsection*{Determining $\tau_{as}$}

$\tau_{as}$ is the torque necessary for the motor to counter the load applied by the arm and the stick. It can be divided into two parts as in \autoref{eq:TauasBegin}.

\begin{equation}\label{eq:TauasBegin}
	\tau_{as}=\tau_a+\tau_s \addunit{\newton\meter}
\end{equation}
\startexplain
\explain{$\tau_a$ is the load of the arm}{\si{\newton\meter}}
\explain{$\tau_s$ is the load of the stick}{\si{\newton\meter}}
\stopexplain

The first part is the torque to counter the load of the arm, $\tau_a$. It is subjected to two torques as explained in \autoref{eq:TauAdef}.

\begin{equation}\label{eq:TauAdef}
	\tau_a=\tau_{a_{gravity}}+\tau_{a_{momentum}} \addunit{\newton\meter}
\end{equation}

 $\tau_{a_{gravity}}$ is the torque generated by the gravity. It is decided to approximate this torque by defining the arm as a pendulum with a weightless rod and all its mass is on the GC as a point as shown in \autoref{fig:tauAgrav}.
 
 \begin{figure}[htbp]
 	\centering
 	\includegraphics[width=0.5\textwidth]{PendulumWithWeightlessRod}
 	\caption{Approximation of the arm as a weightless rod pendulum}\label{fig:tauAgrav}
 \end{figure}
 
 From \autoref{fig:tauAgrav}, \autoref{eq:tauAgrav} can be deduced.

\begin{equation}\label{eq:tauAgrav}
	\tau_{a_{gravity}}=M_a g \frac{l_a}{2} sin(\theta_a) \addunit{\newton\meter}
\end{equation}
\startexplain
\explain{$M_a$ is the mass of the arm}{\si{\kilogram}}
\stopexplain

$\tau_{a_{momentum}}$ is the torque of the momentum of the arm when it moves. This can be translated by the \autoref{eq:ArmMomentum}.

\begin{equation}\label{eq:ArmMomentum}
	\tau_{a_{momentum}}=-J_a \ddot\theta_a\ \addunit{\newton\meter}
\end{equation}
\startexplain
\explain{$J_a$ is the moment of inertia of the arm}{\si{\kilogram\meter\squared}}
\stopexplain

By combining and linearizing Equations (\ref{eq:ArmMomentum}) and (\ref{eq:tauAgrav}) \autoref{eq:finalTauA} is derived.

\begin{flalign}\label{eq:finalTauA}
	\tau_a&=-J_a \ddot{\theta}_a+M_a g \frac{l_a}{2} \theta_a \addunit{\newton\meter} \notag\\
	\mathcal{L}\{\tau_a\}=\tau_a(s)&=-J_a\Theta_a s^2+M_a g \frac{l_a}{2} \Theta_a \addunit{1}
\end{flalign}

Now the load of the stick $\tau_s$ is studied. It is also composed of two torques in the same fashion as the arm.

\begin{subequations}\label{eq:TauS}
	\begin{flalign}
		\tau_s&=\tau_{s_{momentum}}+\tau_{s_{gravity}} \addunit{\newton\meter}\\
		\tau_{s_{momentum}}&=-J_s \ddot{\theta}_s \addunit{\newton\meter}\label{eq:TausMomentum}\\
		\tau_{s_{momentum}}&=b_{as}(\dot{\theta}_s-\dot{\theta}_a)-\frac{ls}{2}M_s\left(-l_a\ddot{\theta}_a-\frac{l_s}{2}\ddot{\theta}_s+g\theta_s\right)\addunit{\newton\meter}\\
		\tau_{s_{gravity}}&=M_s g \left[l_a sin(\theta_a)+\frac{l_s}{2}sin(\theta_s)\right] \addunit{\newton\meter}		
	\end{flalign}
\end{subequations}

By linearizing \autoref{eq:TauS} \autoref{eq:LinTauS} is found.

\begin{flalign}\label{eq:LinTauS}
	\tau_s&=M_s g \left(\theta_a l_a+\frac{l_s}{2}\theta_s\right)+b_{as}(\dot{\theta}_s-\dot{\theta}_a)\notag\\
	&-\frac{ls}{2}M_s\left(-l_a\ddot{\theta}_a-\frac{l_s}{2}\ddot{\theta}_s+g\theta_s\right) \addunit{\newton\meter}
\end{flalign}

However since only $\theta_a$ is wanted in the equation $\Theta_s$ is then replaced by $\Theta_a$ according to \autoref{eq:tfArmStick} which gives \autoref{eq:FinalTauS}.

\begin{equation}\label{eq:FinalTauS}
	\mathcal{L}\{\tau_{s}\}=\tau_{s}(s)=M_sl_a\Theta_a+s^2\frac{l_s}{2}l_aM_s\Theta_a+s^2\frac{l_s^2}{4}M_s\left(\frac{\frac{-3l_a}{2l_s}s^2}{s^2-\frac{3g}{2l_s}}\right)\Theta_a \addunit{1}
\end{equation}

At last $\tau_{as}$ is found by combining Equations \eqref{eq:finalTauA} and \eqref{eq:FinalTauS} in \autoref{eq:FinalTauAS}.

\begin{subequations}\label{eq:FinalTauAS}
	\begin{flalign}
		\tau_{as} &=\tau_a+\tau_s \addunit{\newton\meter}\\
		&= -J_a\Theta_a s^2+M_a g \frac{l_a}{2} \Theta_a+M_sl_a\Theta_a+s^2\frac{l_s}{2}l_aM_s\Theta_a\notag \\
		&+s^2\frac{l_s^2}{4}M_s\left(\frac{\frac{-3l_a}{2l_s}s^2}{s^2-\frac{3g}{2l_s}}\right)\Theta_a \addunit{1}
	\end{flalign}
\end{subequations} 

By combining Equations \eqref{eq:TauL}, \eqref{eq:FinalTauAS} and \eqref{eq:TaufSimplified} $\tau_l$ is then defined as \autoref{eq:finalTauL}.

\begin{flalign}\label{eq:finalTauL}
	\tau_l	&=-J_a\Theta_a s^2+M_a g \frac{l_a}{2} \Theta_a+M_sl_a\Theta_a+s^2\frac{l_s}{2}l_aM_s\Theta_a\notag \\
			&+s^2\frac{l_s^2}{4}M_s\left(\frac{\frac{-3l_a}{2l_s}s^2}{s^2-\frac{3g}{2l_s}}\right)\Theta_a\notag \\
			&+(J_{gear}s +B_{gear})\Omega_m(s) \addunit{1}
\end{flalign}


\input{chapters/"Modeling"/MotorGearsTFComplete}
\input{chapters/"Modeling"/MotorGearsTFSimplified}


Since it is a change in the small angles the linearization of a cosine and a sine function gives \autoref{eq:BasLin}.

\begin{subequations}\label{eq:BasLin}
	\begin{flalign}
		&sin(x)=>x \addunit{1}\\
		&cos(x)=>1 \addunit{1}
	\end{flalign}
\end{subequations}

\autoref{fig:BasLinPlot} shows that within an angle variation of \SI{10}{\degree} the approximation of the linearization is acceptable.

\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.8\textwidth]{CosSinLinApprox}
	\caption{Error generated by the approximation of the cosine and the sine function}\label{fig:BasLinPlot}
\end{figure}

